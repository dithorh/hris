@model IEnumerable<hris.ViewModels.LeaveApprovalViewModel>
@section Style{
    <style>
        .dropdown-menu {
            min-width: 6rem !important;
        }

        div.dropdown-menu.dropdown-menu-right.show {
            padding: 5px 0;
            margin: 2px 0 0;
        }

        .dropdown-item {
            margin: 0;
            padding: 0 9px 0;
        }
    </style>
}
<div class="page-header page-header-light">
    <div class="page-header-content header-elements-md-inline">
        <div class="page-title d-flex">
            <h4><span class="font-weight-semibold">List Approval Cuti</span></h4>
            <a href="#" class="header-elements-toggle text-default d-md-none"><i class="icon-more"></i></a>
        </div>
    </div>

    <div class="breadcrumb-line breadcrumb-line-light header-elements-md-inline">
        <div class="d-flex">
            <div class="breadcrumb">
                <a href="#" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Home</a>
                <span class="breadcrumb-item active">List Approval Cuti</span>
            </div>

            <a href="#" class="header-elements-toggle text-default d-md-none"><i class="icon-more"></i></a>
        </div>
    </div>
</div>

<div class="content">
    <div class="card border-dark">
        <div class="card-header header-elements-inline bg-slate-700">
            <div class="card-title"></div>
            <div class="header-elements">
                <div class="list-icons">
                    <a class="list-icons-item" data-action="collapse"></a>
                    <a class="list-icons-item" data-action="reload"></a>
                    <a class="list-icons-item" data-action="remove"></a>
                </div>
            </div>
        </div>
        <table class="table dataTables-modals-noadd table-bordered">
            <thead>
                <tr>
                    <th>No</th>
                    <td>Nama</td>
                    <th>Tanggal Cuti</th>
                    <th>Jumlah Hari</th>
                    <th>Jenis Cuti</th>
                    <th>Alasan</th>
                    <th>Tanggal Pengajuan</th>
                    <th>Approval</th>
                    @*<th>Approval HRD</th>*@
                    @*<th class="no-sort">Actions</th>*@
                </tr>
            </thead>
            <tbody>
                @{
                    if (Model != null && Model.Count() > 0)
                    {
                        int i = 0;

                        foreach (var item in Model)
                        {
                            i++;
                            <tr>
                                <td align="center">
                                    @i
                                </td>
                                <td>@item.nama_karyawan</td>
                                <td align="center">
                                    @string.Format("{0:dd/MM/yyyy}", item.tgl_mulai_cuti) s/d @string.Format("{0:dd/MM/yyyy}", item.tgl_selesai_cuti)
                                </td>
                                <td align="center">@item.jml_hari</td>
                                <td>@item.jenis_cuti</td>
                                <td>@item.alasan</td>
                                <td>@string.Format("{0:MM/dd/yyyy}", item.tgl_pengajuan)</td>
                                <td align="center">
                                    @if (item.status_approval1 == "Pending")
                                    {
                                        <div class="dropdown">
                                            <a href="#" class="badge bg-warning dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Pending</a>
                                            <input type="hidden" value="@item.pengajuan_cuti_id" />
                                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(71px, 20px, 0px);">
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-hour-glass mr-2 bg-warning"></span>
                                                    Pending
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon icon-checkmark2 mr-2 bg-success"></span>
                                                    Approved
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-cross2 mr-2 bg-danger"></span>
                                                    Rejected
                                                </a>
                                            </div>
                                        </div>
                                    }
                                    else if (item.status_approval1 == "Approved")
                                    {
                                        <div class="dropdown">
                                            <a href="#" class="badge bg-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Approved</a>
                                            <input type="hidden" value="@item.pengajuan_cuti_id" />
                                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(71px, 20px, 0px);">
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-hour-glass mr-2 bg-warning"></span>
                                                    Pending
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon icon-checkmark2 mr-2 bg-success"></span>
                                                    Approved
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-cross2 mr-2 bg-danger"></span>
                                                    Rejected
                                                </a>
                                            </div>
                                        </div>
                                    }
                                    else if (item.status_approval1 == "Rejected")
                                    {
                                        <div class="dropdown">
                                            <a href="#" class="badge bg-danger dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Rejected</a>
                                            <input type="hidden" value="@item.pengajuan_cuti_id" />
                                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(71px, 20px, 0px);">
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-hour-glass mr-2 bg-warning"></span>
                                                    Pending
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon icon-checkmark2 mr-2 bg-success"></span>
                                                    Approved
                                                </a>
                                                <a href="#" class="dropdown-item">
                                                    <span class="icon-cross2 mr-2 bg-danger"></span>
                                                    Rejected
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </td>
                                @*<td align="center">
                                        @if (item.status_approval2 == "Pending")
                                        {
                                            <span class="badge badge-warning">Pending</span>
                                        }
                                        else if (item.status_approval2 == "Approved")
                                        {
                                            <span class="badge badge-success">Approved</span>
                                        }
                                        else if (item.status_approval2 == "Rejected")
                                        {
                                            <span class="badge badge-danger">Rejected</span>
                                        }
                                    </td>*@
                                @*<td align="center">
                                        <a href="javascript:createModal('@Url.Action("Edit", new { id = item.pengajuan_cuti_id })')" class="text-inverse p-r-10" data-toggle="tooltip" title="" data-original-title="Edit"><i class="icon-pencil7"></i></a>
                                        <a href="javascript:deleteItem(@item.pengajuan_cuti_id);" class="text-inverse" title="" data-toggle="tooltip" data-original-title="Delete"><i class="icon-eraser2"></i></a>
                                    </td>*@
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!--Modal-->
<div id="AddModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-teal">
            <div class="modal-header bg-teal">
                <h5 class="modal-title">Tambah Data</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <form action="#" class="form-validate-jquery">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-6">
                                <label>Tanggal Cuti</label>
                                <div class="input-group">
                                    <span class="input-group-prepend">
                                        <span class="input-group-text"><i class="icon-calendar22"></i></span>
                                    </span>
                                    <input type="text" class="form-control daterange-basic">
                                    <input id="tgl_mulai_cuti" type="hidden">
                                    <input id="tgl_selesai_cuti" type="hidden">
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <label>Jumlah Hari</label>
                                <input id="jml_hari" type="text" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-6">
                                <label>Jenis Cuti</label>
                                <select id="jenis_cuti" class="form-control form-control-sm select2">
                                    <option value="">Pilih</option>
                                    <option value="Pribadi">Pribadi</option>
                                    <option value="Izin">Izin</option>
                                    <option value="Sakit">Sakit</option>
                                    <option value="Hamil">Hamil</option>
                                    <option value="Nikah">Nikah</option>
                                    <option value="Setengah Hari">Setengah Hari</option>
                                    <option value="Potong Gaji">Potong Gaji</option>
                                    <option value="Lainya">Lainya</option>
                                </select>
                            </div>

                            <div class="col-sm-6">
                                <label>Alasan</label>
                                <input id="alasan" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="Add" type="submit" class="btn bg-primary ">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="EditModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-teal" id="editContent">
        </div>
    </div>
</div>
<!-- /End Modal-->

@section Scripts{
    <script type="text/javascript">
        Noty.overrideDefaults({
            theme: 'limitless',
            layout: 'topRight',
            type: 'alert',
            timeout: 1500
        });

        $('div.dropdown > div > a').on('click', function () {
            var status = $(this).text().trim();
            var curStatus = $('div.dropdown > a').text().trim();
            var id = $('div.dropdown > input').val();

            if(curStatus != status){
                updateItem(id, status);
            }
        });

        function createModal(url) {
            $('#editContent').load(url);
            $('#EditModal').modal('show');
        }

        $('#AddModal').on('hidden.bs.modal', function (e) {
            $("#jenis_cuti").select2('val', '');
            $(this).find('form')[0].reset();
        });

        $('.daterange-basic').daterangepicker({
            applyClass: 'bg-slate-600',
            cancelClass: 'btn-light',
            autoApply: true,
            autoUpdateInput: false,
            locale: {
                format: 'DD/MM/YYYY',
                cancelLabel: 'Clear'
            }
        }, function (start, end, label) {
            var one_day = 1000 * 60 * 60 * 24;
            var dtstart = new Date(start);
            var dtend = new Date(end);
            var diffDays = Math.round(Math.abs((dtstart.getTime() - dtend.getTime()) / one_day));
            $('#jml_hari').val(diffDays);
        });

        $('.daterange-basic').on('apply.daterangepicker', function (ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            $('#tgl_mulai_cuti').val(picker.startDate.format('MM/DD/YYYY'));
            $('#tgl_selesai_cuti').val(picker.endDate.format('MM/DD/YYYY'));
        });

        $('.daterange-basic').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });

        //Update
        function updateItem(id, status) {
            console.log(id);
            var token = $('input[name=__RequestVerificationToken]').val();
            var approval = new Object();
            approval.pengajuan_cuti_id = id;
            approval.status_approval1 = status;

            swal({
                title: 'Are you sure?',
                text: "The status will be update!",
                type: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, update it!',
                cancelButtonText: 'No, cancel!',
                confirmButtonClass: 'btn btn-success',
                cancelButtonClass: 'btn btn-danger',
                buttonsStyling: false
            }).then((isConfirm) => {
                if (isConfirm.value) {
                    $.ajax({
                        url: '@Url.Action("Edit")',
                        type: 'POST',
                        data: { __RequestVerificationToken: token, approvalLeave: approval },
                        success: function (data) {
                            if (data == "0")
                                swal({
                                    type: 'success',
                                    title: 'Updated!',
                                    text: 'Status has been successfully updated.',
                                    timer: 1500
                                }).then(function () {
                                    location.reload();
                                });
                            else
                                swal(
                                    'Error!',
                                    'Oopss... there has been error. Please contact administrator',
                                    'error'
                                );
                        },
                        error: function () {
                            swal(
                                'Error!',
                                'Oopss... there has been error. Please contact administrator',
                                'error'
                            );
                        }
                    });
                } else {
                    swal('Action has been cancelled!');
                }
            });
        }
    </script>
}
